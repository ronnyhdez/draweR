---
title: "Trying R for remote sensing"
author: "Ronny A. Hern√°ndez Mora"
date: "02/04/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Exporting a COG (Cloud Optimized Geotiff) file from GEE

The idea is to document steps to export from Google Earth Engine a COG file
(or several) to Google Drive to be imported latter in R for analysis. 

## GEE first example

As a first approach, I followed a tutorial from the [Google documentation:](https://developers.google.com/earth-engine/guides/exporting)

```{js, eval = FALSE}
// Load a landsat image and select three bands.
var landsat = ee.Image('LANDSAT/LC08/C01/T1_TOA/LC08_123032_20140515')
  .select(['B4', 'B3', 'B2']);

// Create a geometry representing an export region.
var geometry = ee.Geometry.Rectangle([116.2621, 39.8412, 116.4849, 40.01236]);

// Retrieve the projection information from a band of the original image.
// Call getInfo() on the projection to request a client-side object containing
// the crs and transform information needed for the client-side Export function.
var projection = landsat.select('B2').projection().getInfo();

// Export a cloud-optimized GeoTIFF.
Export.image.toDrive({
  image: landsat,
  description: 'imageToCOGeoTiffExample',
  crs: projection.crs,
  crsTransform: projection.transform,
  region: geometry,
  folder: "GEE_testing",
  fileFormat: 'GeoTIFF',
  formatOptions: {
    cloudOptimized: true
  }
});
```

Then, this file was imported to R with help of the `terra` package:

```{r}
library(terra)

check <- rast("data/imageToCOGeoTiffExample.tif")
```

And, to validate, I plotted the file using a base R function:

```{r}
plot(check)

plotRGB(check, axes = TRUE, stretch = "lin", main = "Landsat True Color Composite")
```


## References

 - https://rspatial.org/terra/pkg/1-introduction.html
 - https://geocompr.robinlovelace.net/read-write.html#raster-data-read
 - https://rspatial.org/raster/rs/2-exploration.html
 - https://developers.google.com/earth-engine/guides/exporting

# `terra` package tutorial

All the code and examples here were created using the information in 
[rspatial.org](https://rspatial.org/terra/rs/1-introduction.html)

## Downloading example data

```{r eval = FALSE}
if (!fs::dir_exists("data")) {
  dir.create("data", showWarnings = FALSE)
}

if (!file.exists("data/rs/samples.rds")) {
    download.file("https://biogeo.ucdavis.edu/data/rspatial/rs.zip", dest = "data/rs.zip")
    unzip("data/rs.zip", exdir="data")
}
```


## Working with MODIS data

The documentation states that we should work with the `luna` package, but it's
not on CRAN, so I downloaded directly from the [GitHub](https://github.com/rspatial/luna)

```{r}
# remotes::install_github("rspatial/luna")
library(terra)
library(luna)

# Check products available through package API's
prod <- getProducts()
head(prod)

# Check just the MODIS products
modis <- getProducts("^MOD|^MYD|^MCD")
head(modis)


# To redirect to MODIS info webpage
## Examples comes with MOD09A1
## I'm interested in MOD09GA
productInfo("MOD09GA")

# Queremos descargar los datos
## Necesitamos area de interes
## Fecha de inicio y de fin

nicoya <- geodata::gadm("Costa Rica", level = 1, path = ".")
nicoya

guanacaste <- nicoya[nicoya$NAME_1 == "Guanacaste", ] 

# Plot area
plot(nicoya, col = "light gray")
lines(guanacaste, col = "red", lwd = 2)

# Check MODIS data available for the area of interest
mf <- luna::getModis(product = "MOD09GA", 
                     start_date = "2015-01-01", 
                     end_date = "2015-01-07", 
                     aoi = guanacaste,
                     download = FALSE)
mf

# Let's download some data
username <- Sys.getenv("EARTHDATA_USER")
passwd <- Sys.getenv("EARTHDATA_PASSWD")

mf <- luna::getModis(product = "MOD09GA", 
                     start_date = "2015-01-01", 
                     end_date = "2015-01-07", 
                     aoi = guanacaste,
                     download = TRUE,
                     path = here::here("data"),
                     username = username,
                     password = passwd)
mf

# https://rspatial.org/terra/modis/4-quality.html
```





















